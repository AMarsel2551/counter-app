<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–≤–µ–ª–∏—á–∏—Ç—å —Å—á–µ—Ç—á–∏–∫</title>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://unpkg.com/@ton/ton@latest/dist/ton.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .tonkeeper-button {
            background: linear-gradient(135deg, #0088cc, #006699);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin: 10px 0;
            box-shadow: 0 4px 10px rgba(0,136,204,0.3);
        }
        .tonkeeper-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,136,204,0.4);
        }
        .toggle-button {
            background: #666;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        .json-view {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .payload-view {
            background: #e8f4fc;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-size: 12px;
            word-break: break-all;
        }
        .mode-selector {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        .mode-selector button {
            flex: 1;
            padding: 10px;
            border: 2px solid #0088cc;
            background: white;
            color: #0088cc;
            border-radius: 5px;
            cursor: pointer;
        }
        .mode-selector button.active {
            background: #0088cc;
            color: white;
        }
    </style>
</head>
<body>
<h1>üî¢ –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞</h1>

<div class="container">
    <div class="mode-selector">
        <button id="mode-tonkeeper" class="active" onclick="setMode('tonkeeper')">
            üîó –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ Tonkeeper
        </button>
        <button id="mode-wallet" onclick="setMode('wallet')">
            üè¶ –ß–µ—Ä–µ–∑ TON Connect
        </button>
    </div>

    <!-- –†–µ–∂–∏–º Tonkeeper Deeplink -->
    <div id="tonkeeper-mode" style="display: block;">
        <h3>1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ:</h3>
        <div>
            <button onclick="setIncreaseBy(1)">–£–≤–µ–ª–∏—á–∏—Ç—å –Ω–∞ 1</button>
            <button onclick="setIncreaseBy(5)">–£–≤–µ–ª–∏—á–∏—Ç—å –Ω–∞ 5</button>
            <button onclick="setIncreaseBy(10)">–£–≤–µ–ª–∏—á–∏—Ç—å –Ω–∞ 10</button>
        </div>

        <h3>2. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É:</h3>
        <button class="tonkeeper-button" onclick="openTonkeeper()">
            üî¢ –£–≤–µ–ª–∏—á–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –Ω–∞ <span id="increase-value">1</span> (0.05 TON)
        </button>

        <h3>3. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h3>
        <div class="json-view">
            {
            "increaseBy": <span id="json-increase">1</span>,
            "queryId": <span id="json-queryid">1700000000</span>
            }
        </div>

        <div class="payload-view">
            Deeplink: <span id="deeplink-output"></span>
        </div>
    </div>

    <!-- –†–µ–∂–∏–º TON Connect -->
    <div id="wallet-mode" style="display: none;">
        <h3>1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫:</h3>
        <div id="ton-connect"></div>

        <h3>2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</h3>
        <div class="json-view" id="json-config">
            {
            "queryId": 1700000000,
            "increaseBy": 1
            }
        </div>

        <h3>3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é:</h3>
        <button id="send-button" onclick="sendTransaction()" disabled>
            üî¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å IncreaseCounter
        </button>
    </div>
</div>

<script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    const CONTRACT_ADDRESS = "kQB0ZLdBQNHaAtaOwNAwO-YHI9KIImcUSfQlc8zSJjkrcAyv";
    const CONTRACT_ADDRESS_RAW = "EQB0ZLdBQNHaAtaOwNAwO-YHI9KIImcUSfQlc8zSJjkrcLcl";
    const INCREASE_AMOUNT = "50000000"; // 0.05 TON

    let currentMode = 'tonkeeper';
    let currentIncreaseBy = 1;
    let currentQueryId = Math.floor(Date.now() / 1000);

    // ========== –†–ï–ñ–ò–ú TONKEEPER DEEPLINK ==========

    function setMode(mode) {
        currentMode = mode;

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞
        document.getElementById('mode-tonkeeper').classList.toggle('active', mode === 'tonkeeper');
        document.getElementById('mode-wallet').classList.toggle('active', mode === 'wallet');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
        document.getElementById('tonkeeper-mode').style.display = mode === 'tonkeeper' ? 'block' : 'none';
        document.getElementById('wallet-mode').style.display = mode === 'wallet' ? 'block' : 'none';

        if (mode === 'tonkeeper') {
            updateTonkeeperUI();
        }
    }

    function setIncreaseBy(value) {
        currentIncreaseBy = value;
        currentQueryId = Math.floor(Date.now() / 1000);
        updateTonkeeperUI();
    }

    function updateTonkeeperUI() {
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        document.getElementById('increase-value').textContent = currentIncreaseBy;
        document.getElementById('json-increase').textContent = currentIncreaseBy;
        document.getElementById('json-queryid').textContent = currentQueryId;

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º deeplink
        const deeplink = generateTonkeeperDeeplink();
        document.getElementById('deeplink-output').textContent =
            deeplink.length > 80 ? deeplink.substring(0, 80) + '...' : deeplink;
    }

    function generateTonkeeperDeeplink() {
        // –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, Tonkeeper –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä—è–º—É—é –ø–µ—Ä–µ–¥–∞—á—É –±–∏–Ω–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ deeplink
        // –ü–æ—ç—Ç–æ–º—É –º—ã –º–æ–∂–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ TON, –Ω–æ –Ω–µ IncreaseCounter —Å–æ–æ–±—â–µ–Ω–∏–µ

        // –í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä–æ—Å—Ç–æ–π –ø–µ—Ä–µ–≤–æ–¥ (–±–µ–∑ —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞)
        return `ton://transfer/${CONTRACT_ADDRESS}?amount=${INCREASE_AMOUNT}&text=Increase+by+${currentIncreaseBy}`;

        // –í–∞—Ä–∏–∞–Ω—Ç 2: –ü–æ–ø—ã—Ç–∫–∞ —Å hex –¥–∞–Ω–Ω—ã–º–∏ (–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Tonkeeper!)
        // const hexData = `7e8764ef${currentQueryId.toString(16).padStart(16,'0')}${currentIncreaseBy.toString(16).padStart(8,'0')}`;
        // return `ton://transfer/${CONTRACT_ADDRESS}?amount=${INCREASE_AMOUNT}&bin=${hexData}`;
    }

    function openTonkeeper() {
        const deeplink = generateTonkeeperDeeplink();
        console.log("Opening Tonkeeper deeplink:", deeplink);

        // –ü—Ä–æ–±—É–µ–º –æ—Ç–∫—Ä—ã—Ç—å Tonkeeper
        window.location.href = deeplink;

        // –§–æ–ª–±—ç–∫: –µ—Å–ª–∏ Tonkeeper –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
        setTimeout(() => {
            if (document.hasFocus()) {
                alert("Tonkeeper –Ω–µ –Ω–∞–π–¥–µ–Ω! –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Tonkeeper –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∂–∏–º TON Connect.");
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Tonkeeper
                window.open('https://tonkeeper.com', '_blank');
            }
        }, 1000);
    }

    // ========== –†–ï–ñ–ò–ú TON CONNECT ==========

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TON Connect
    const connector = new TON_CONNECT_UI.TonConnect({
        manifestUrl: window.location.origin + '/counter-app/tonconnect-manifest.json'
    });

    const ui = new TON_CONNECT_UI.TonConnectUI({
        connector: connector,
        uiPreferences: { theme: 'DARK' },
        buttonRootId: 'ton-connect'
    });

    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è TON Connect
    let messageConfig = {
        queryId: Math.floor(Date.now() / 1000),
        increaseBy: 1
    };

    function updateIncreaseBy(value) {
        messageConfig = {
            queryId: Math.floor(Date.now() / 1000),
            increaseBy: value
        };

        document.getElementById('json-config').textContent =
            JSON.stringify(messageConfig, null, 2);
        generatePayload();
    }

    function generatePayload() {
        try {
            if (typeof window.ton === 'undefined') return;

            const { beginCell } = window.ton;
            const cell = beginCell()
                .storeUint(0x7e8764ef, 32)
                .storeUint(BigInt(messageConfig.queryId), 64)
                .storeUint(messageConfig.increaseBy, 32)
                .endCell();

            return cell.toBoc().toString("base64");
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ payload:', error);
            return null;
        }
    }

    async function sendTransaction() {
        if (!connector.connected) {
            alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫!');
            return;
        }

        try {
            const sendButton = document.getElementById('send-button');
            sendButton.disabled = true;
            sendButton.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';

            const payloadBase64 = generatePayload();
            if (!payloadBase64) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å payload');

            const transaction = {
                validUntil: Math.floor(Date.now() / 1000) + 300,
                messages: [{
                    address: CONTRACT_ADDRESS,
                    amount: INCREASE_AMOUNT,
                    payload: payloadBase64
                }]
            };

            const result = await connector.sendTransaction(transaction);
            alert(`‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω–∞: ${messageConfig.increaseBy}`);
            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç:', result);

            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            updateIncreaseBy(messageConfig.increaseBy);

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
            alert(error.message.includes('User rejected')
                ? '‚ùå –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º'
                : '‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        } finally {
            const sendButton = document.getElementById('send-button');
            sendButton.disabled = false;
            sendButton.textContent = 'üî¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å IncreaseCounter';
        }
    }

    // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫–æ—à–µ–ª—å–∫–∞
    connector.onStatusChange((wallet) => {
        document.getElementById('send-button').disabled = !wallet;
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
        updateTonkeeperUI();
    });
</script>
</body>
</html>